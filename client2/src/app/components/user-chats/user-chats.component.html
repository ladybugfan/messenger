<div class="telegram-container">
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <mat-toolbar color="primary" class="toolbar">
    </mat-toolbar>

    <div class="content">
        <div class="resizable-container">
            <div class="sidebar" id="sidebar">
                <mat-nav-list>
                    <mat-list-item *ngFor="let room of dataSource.data" (click)="selectRoom(room)"
                        [class.selected]="room.id === selectedRoom?.id">

                        <div class="chat-info">
                            <div>rkofkdok</div>
                            <div class="room-name">{{ room?.username }}</div>
                            <div class="room-info">{{ room?.encryption_algorithm }}/{{ room?.encryption_mode
                                }}/{{ room.padding_mode }}</div>
                        </div>

                        <div class="room-actions">
                            <button class="joinRoom" *ngIf="room.isAvailable" mat-stroked-button color="primary"
                                (click)="joinRoom(room.id)">
                                –í—Å—Ç—É–ø–∏—Ç—å
                            </button>

                            <button *ngIf="!room.isAvailable" mat-icon-button [matMenuTriggerFor]="roomMenu"
                                (click)="$event.stopPropagation()">
                                <mat-icon>more_vert</mat-icon>
                            </button>

                            <!-- –ú–µ–Ω—é —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ -->
                            <mat-menu #roomMenu="matMenu">
                                <button mat-menu-item (click)="leaveRoom(room.id)">
                                    <mat-icon>logout</mat-icon>
                                    <span>–ü–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç</span>
                                </button>
                                <button mat-menu-item (click)="deleteRoom(room.id)">
                                    <mat-icon>delete</mat-icon>
                                    <span>–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</span>
                                </button>
                            </mat-menu>
                        </div>

                    </mat-list-item>
                </mat-nav-list>
            </div>




            <div class="chat-window" *ngIf="selectedRoom; else selectChatPrompt">
                <div class="chat-header">
                    <h2>{{ selectedRoom.username }}</h2>
                </div>

                <div *ngIf="selectedRoom.isAvailable; else chatContent">
                    <div class="join-message">
                        <h3>–í—ã –µ—â—ë –Ω–µ –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —á–∞—Ç!</h3>
                        <button mat-raised-button color="accent" (click)="joinRoom(selectedRoom.id)">
                            –í—Å—Ç—É–ø–∏—Ç—å
                        </button>
                    </div>
                </div>

                <ng-template #chatContent>
                    <div class="messages" #messagesContainer>
                        <div *ngFor="let message of currentChatMessages; trackBy: trackByMessageId" class="message"
                            [class.self]="message.sender_id === currentUserId">

                            <div class="message-bubble">
                                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                                <p *ngIf="message.message_text">{{ message.message_text }}</p>

                                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                <div *ngIf="message.file_type && message.file_type.startsWith('image') && message.file_path"
                                    class="chat-image-container">
                                    <img [src]="message.file_path" alt="image" class="chat-image" />
                                </div>

                                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–¥–µ–æ -->
                                <video
                                    *ngIf="message.file_path && message.file_type && message.file_type.startsWith('video')"
                                    controls class="chat-video">
                                    <source [src]="message.file_path" type="video/mp4">
                                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                                </video>

                                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (–¥–æ–∫—É–º–µ–Ω—Ç—ã, PDF, ZIP) -->
                                <a *ngIf="message.file_path && message.file_type && message.file_type.startsWith('application')"
                                    [href]="message.file_path" target="_blank" class="chat-file">
                                    üìÑ –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                                </a>
                            </div>
                        </div>
                    </div>


                    <div class="message-input">
                        <mat-form-field appearance="outline" class="input-field">
                            <mat-label>–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...</mat-label>
                            <textarea matInput [(ngModel)]="newMessage"
                                [disabled]="!isSecondUserConnected || selectedRoom.isAvailable || !!selectedFile"></textarea>
                        </mat-form-field>

                        <!-- –ü–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ -->
                        <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none;">
                        <button mat-icon-button (click)="fileInput.click()"
                            [disabled]="!isSecondUserConnected || !!newMessage.length">
                            <mat-icon>attach_file</mat-icon>
                        </button>

                        <div *ngIf="selectedFile" class="selected-file">
                            <span>{{ selectedFile.name }}</span>
                            <button mat-icon-button (click)="removeFile()">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                        <button mat-raised-button color="primary"
                            (click)="sendMessage(selectedRoom.id, selectedRoom.other_user_id, selectedRoom.encryption_algorithm,selectedRoom.encryption_mode,selectedRoom.padding_mode)"
                            [disabled]="!isSecondUserConnected || selectedRoom.isAvailable || (!newMessage && !selectedFile)">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>

                </ng-template>

            </div>

            <ng-template #selectChatPrompt>
                <div class="empty-chat">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</h3>
                </div>
            </ng-template>

        </div>
    </div>
</div>